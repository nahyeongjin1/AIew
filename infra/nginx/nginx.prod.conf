# =============================================================================
# 프로덕션 Nginx 설정 (Blue-Green 배포 지원)
# =============================================================================
#
# 주요 변경점 (기존 대비):
#   - upstream 정의를 외부 파일(upstream.conf)에서 include
#   - Let's Encrypt → Cloudflare Origin Certificate
#   - Blue-Green 전환은 upstream.conf 심볼릭 링크로 처리
#
# =============================================================================

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    access_log /dev/stdout;
    error_log  /dev/stderr warn;

    sendfile          on;
    tcp_nopush        on;
    keepalive_timeout 65;
    server_tokens     off;
    client_max_body_size 100M;  # 파일 업로드 제한

    # -------------------------------------------------------------------------
    # Cloudflare Real IP 설정
    # -------------------------------------------------------------------------
    # Cloudflare Proxy IP 범위 (https://www.cloudflare.com/ips/)
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    # IPv6
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;
    real_ip_header CF-Connecting-IP;

    # -------------------------------------------------------------------------
    # Cloudflare IP만 허용 (원본 서버 보호)
    # -------------------------------------------------------------------------
    # Cloudflare를 우회한 직접 접근 차단
    # $realip_remote_addr 사용: set_real_ip_from 적용 전의 원래 연결 IP (Cloudflare IP)
    geo $realip_remote_addr $is_cloudflare {
        default 0;
        # IPv4
        173.245.48.0/20 1;
        103.21.244.0/22 1;
        103.22.200.0/22 1;
        103.31.4.0/22 1;
        141.101.64.0/18 1;
        108.162.192.0/18 1;
        190.93.240.0/20 1;
        188.114.96.0/20 1;
        197.234.240.0/22 1;
        198.41.128.0/17 1;
        162.158.0.0/15 1;
        104.16.0.0/13 1;
        104.24.0.0/14 1;
        172.64.0.0/13 1;
        131.0.72.0/22 1;
        # IPv6
        2400:cb00::/32 1;
        2606:4700::/32 1;
        2803:f800::/32 1;
        2405:b500::/32 1;
        2405:8100::/32 1;
        2a06:98c0::/29 1;
        2c0f:f248::/32 1;
    }

    # Gzip 압축
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss;

    # Rate limiting zones (real client IP 기준)
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;

    # =========================================================================
    # Upstream 설정 (외부 파일에서 include)
    # =========================================================================
    # upstream.conf는 심볼릭 링크로, upstream-blue.conf 또는 upstream-green.conf를 가리킴
    # Blue-Green 전환 시: ln -sf upstream-green.conf upstream.conf && nginx -s reload
    include /etc/nginx/upstream.conf;

    # =========================================================================
    # HTTP → HTTPS 리다이렉트
    # =========================================================================
    server {
        listen 80;
        server_name aiew.dev www.aiew.dev;

        # Cloudflare를 우회한 직접 접근 차단
        if ($is_cloudflare = 0) {
            return 403;
        }

        # 모든 HTTP 요청을 HTTPS로 리다이렉트
        location / {
            return 301 https://$server_name$request_uri;
        }

        # Health check (HTTP에서도 응답)
        location /healthz {
            access_log off;
            return 200 'ok';
            add_header Content-Type text/plain;
        }
    }

    # =========================================================================
    # HTTPS 서버 (메인)
    # =========================================================================
    server {
        listen 443 ssl;
        http2 on;
        server_name aiew.dev;

        # Cloudflare를 우회한 직접 접근 차단 (403 반환)
        if ($is_cloudflare = 0) {
            return 403;
        }

        # ---------------------------------------------------------------------
        # SSL 설정 (Cloudflare Origin Certificate)
        # ---------------------------------------------------------------------
        # Cloudflare Dashboard > SSL/TLS > Origin Server에서 발급
        # 15년 유효, 자동 갱신 불필요
        ssl_certificate /etc/nginx/ssl/origin.pem;
        ssl_certificate_key /etc/nginx/ssl/origin-key.pem;
        ssl_dhparam /etc/nginx/ssl/dhparam.pem;

        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;

        # 모던 SSL 설정
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        # ---------------------------------------------------------------------
        # 보안 헤더
        # ---------------------------------------------------------------------
        # HSTS (1년) - Cloudflare와 Origin 모두에서 HTTPS 강제
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # CSP (Content Security Policy)
        add_header Content-Security-Policy "
            default-src 'self';
            script-src 'self' 'unsafe-inline' 'unsafe-eval' https://static.cloudflareinsights.com;
            style-src 'self' 'unsafe-inline';
            img-src 'self' data: https:;
            font-src 'self' data:;
            connect-src 'self'
                wss://aiew.dev
                wss://api.openai.com
                https://api.openai.com
                https://texttospeech.googleapis.com
                https://cloudflareinsights.com;
            media-src 'self' blob: mediastream: data:;
        " always;

        # ---------------------------------------------------------------------
        # 라우팅 규칙
        # ---------------------------------------------------------------------

        # OAuth 경로 → Core API
        location /api/v1/oauth2/ {
            limit_req zone=auth burst=10 nodelay;

            proxy_pass http://core-api/api/v1/oauth2/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_redirect off;
        }

        # WebSocket (Socket.io) → Core API
        location /socket.io/ {
            proxy_pass http://core-api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket timeout (1시간)
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }

        # 메인 트래픽 → Web Client (Next.js)
        location / {
            limit_req zone=general burst=20 nodelay;

            proxy_pass http://web-client;
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_cache_bypass $http_upgrade;
        }

        # OAuth 콜백 (rate limit 완화)
        location ~* ^/auth/callback {
            limit_req zone=auth burst=10 nodelay;

            proxy_pass http://web-client;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check
        location /healthz {
            access_log off;
            return 200 'ok';
            add_header Content-Type text/plain;
        }

        # 정적 파일 캐싱
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
            proxy_pass http://web-client;
            proxy_cache_valid 200 1d;
            expires 1d;
            add_header Cache-Control "public, immutable";
        }
    }

    # =========================================================================
    # www 리다이렉트
    # =========================================================================
    server {
        listen 443 ssl;
        http2 on;
        server_name www.aiew.dev;

        # Cloudflare를 우회한 직접 접근 차단
        if ($is_cloudflare = 0) {
            return 403;
        }

        ssl_certificate /etc/nginx/ssl/origin.pem;
        ssl_certificate_key /etc/nginx/ssl/origin-key.pem;

        return 301 https://aiew.dev$request_uri;
    }
}