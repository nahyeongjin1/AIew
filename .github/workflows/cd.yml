name: CD

on:
  release:
    types: [published]
  workflow_dispatch: # 수동 실행 가능
  workflow_call: # release-please에서 호출

concurrency:
  group: deploy-production
  cancel-in-progress: false # 배포는 완료까지 대기

jobs:
  deploy:
    if: github.repository == 'ku-cse-grad-proj/AIew'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Deploy to OCI
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          command_timeout: 30m
          script: |
            cd ~/aiew

            # 최신 코드 가져오기 (서버 측 로컬 변경사항 무시하고 강제 체크아웃)
            git fetch origin --tags
            git reset --hard HEAD
            git checkout -B ${{ github.ref_name }} origin/${{ github.ref_name }}

            # 배포 스크립트 실행
            ./infra/scripts/deploy.sh "${{ github.ref_name }}" "${{ secrets.GITHUB_TOKEN }}"
